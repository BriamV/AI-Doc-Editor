{
  "hooks": {
    "preSubAgent": [
      {
        "matcher": "task-dev|pr-flow|release-prep|commit-smart|adr-create|issue-generate|docs-update|intelligent-qa|multi-agent-orchestrator|review-complete|security-audit|architecture|debug-analyze",
        "hooks": [
          {
            "type": "command",
            "timeout": 4,
            "command": "echo 'Pre-SubAgent: GitFlow Context Detection (timeout: 4s)...'; BRANCH=$(git branch --show-current 2>/dev/null); export TASK_ID=$(echo \"$BRANCH\" | sed -n 's/.*T-\\([0-9]\\+\\).*/T-\\1/p' | head -1); export RELEASE_ID=$(echo \"$BRANCH\" | sed -n 's/^release\\/R\\([0-9]\\+\\).*/R\\1/p' | head -1); if [[ \"$BRANCH\" =~ ^feature/T-[0-9]+ ]]; then export WORKFLOW_TYPE='task-development'; elif [[ \"$BRANCH\" =~ ^release/R[0-9]+ ]]; then export WORKFLOW_TYPE='release-preparation'; elif [[ \"$BRANCH\" =~ ^hotfix/ ]]; then export WORKFLOW_TYPE='hotfix'; elif [[ \"$BRANCH\" == 'develop' ]]; then export WORKFLOW_TYPE='integration'; elif [[ \"$BRANCH\" == 'main' ]]; then export WORKFLOW_TYPE='production'; else export WORKFLOW_TYPE='general-development'; fi; echo \"Branch: $BRANCH | Workflow: $WORKFLOW_TYPE | Task: ${TASK_ID:-none} | Release: ${RELEASE_ID:-none}\""
          }
        ]
      },
      {
        "matcher": "task-dev|pr-flow|release-prep|commit-smart|adr-create|issue-generate|docs-update|review-complete|security-audit|architecture|debug-analyze",
        "hooks": [
          {
            "type": "command",
            "timeout": 2,
            "command": "echo 'Pre-SubAgent: Sub-Agent Selection (timeout: 2s)...'; case \"$WORKFLOW_TYPE\" in 'task-development') echo 'frontend-developer';; 'release-preparation') echo 'release-manager';; 'hotfix') echo 'hotfix-specialist';; *) echo 'workflow-architect';; esac | { read agent; export SUB_AGENT=\"$agent\"; echo \"Selected sub-agent: $agent\"; }"
          }
        ]
      },
      {
        "matcher": ".*",
        "hooks": [
          {
            "type": "command",
            "timeout": 2,
            "command": "echo 'Pre-SubAgent: Environment Check (timeout: 2s)...'; missing=0; for tool in git node npm; do command -v $tool >/dev/null 2>&1 || { echo \"Missing: $tool\"; missing=1; }; done; [ $missing -eq 0 ] && echo 'Environment ready' || echo 'Environment issues detected'"
          }
        ]
      }
    ],
    "PreToolUse": [
      {
        "matcher": "Edit|Write|MultiEdit",
        "hooks": [
          {
            "type": "command",
            "timeout": 2,
            "command": "[ -f .cc-session-start ] || touch .cc-session-start"
          }
        ]
      },
      {
        "matcher": "Edit|Write|MultiEdit",
        "hooks": [
          {
            "type": "command",
            "timeout": 5,
            "command": "if [ -f .cc-metrics-fail.json ]; then tries=$(cat .cc-refactor-attempts 2>/dev/null || echo 0); next=$((tries+1)); echo $next > .cc-refactor-attempts; python - <<'PY'\nimport json,sys\nj=json.load(open('.cc-metrics-fail.json'))\nprint('\\nüõ†Ô∏è  PLAN DE REFACTOR (objetivo: CC‚â§15 y LOC‚â§300):')\nfor it in j:\n  f=it.get('file'); cc=it.get('cc') or it.get('ccBand'); loc=it.get('loc');\n  tips=[]\n  if (isinstance(cc,int) and cc>15) or cc=='red': tips.append('reduce complejidad: extrae funciones y usa early-returns')\n  if (isinstance(loc,int) and loc>300) or it.get('locBand')=='red': tips.append('divide en m√≥dulos/componentes y extrae helpers')\n  if tips: print(f' - {f}: ' + '; '.join(tips))\nPY\n; if [ $next -ge 3 ]; then echo '‚ö†Ô∏è Intentos de refactor agotados (3). Dejando de fallar autom√°ticamente.'; rm -f .cc-metrics-fail.json .cc-refactor-attempts >/dev/null 2>&1 || true; fi; fi"
          }
        ]
      },
      {
        "matcher": "Edit|Write|MultiEdit",
        "hooks": [
          {
            "type": "command",
            "timeout": 8,
            "command": "missing=0; echo 'Verificando herramientas QA (timeout: 8s)...'; if [ -d backend ] && [ ! -f backend/.venv/bin/activate ] && [ ! -f backend/.venv/Scripts/activate ]; then echo '‚ö†Ô∏è Python virtualenv (backend/.venv) no encontrado. Crea uno con: cd backend && python3 -m venv .venv'; missing=1; fi; for t in markdownlint yamllint shellcheck spectral yamlfix patch taplo; do if ! command -v $t >/dev/null 2>&1; then echo \"‚ö†Ô∏è Herramienta $t no encontrada. Inst√°lala para QA.\"; missing=1; fi; done; if ! command -v shfmt >/dev/null 2>&1 && [ ! -x './bin/shfmt.exe' ]; then echo '‚ö†Ô∏è Herramienta shfmt no encontrada. Inst√°lala para QA.'; missing=1; fi; if [ -f yarn.lock ]; then if ! command -v yarn >/dev/null 2>&1; then echo '‚ö†Ô∏è yarn no encontrado. Inst√°lalo o usa npm.'; missing=1; fi; else if ! command -v npx >/dev/null 2>&1; then echo '‚ö†Ô∏è npx no encontrado. Inst√°lalo para ESLint/Prettier.'; missing=1; fi; fi; if [ -d backend ]; then OS_TYPE=''; if [ -n \"$WSL_DISTRO_NAME\" ] || [ -f /proc/version ] && grep -q Microsoft /proc/version 2>/dev/null; then OS_TYPE='wsl'; elif [[ \"$OSTYPE\" == \"msys\" ]] || [[ \"$OSTYPE\" == \"cygwin\" ]] || [ \"$(uname -o 2>/dev/null)\" = \"Msys\" ]; then OS_TYPE='windows'; else OS_TYPE='linux'; fi; case \"$OS_TYPE\" in 'windows') if [ -f backend/.venv/Scripts/activate ]; then source backend/.venv/Scripts/activate; fi ;; 'wsl'|'linux') if [ -f backend/.venv/bin/activate ]; then source backend/.venv/bin/activate; fi ;; esac; for t in black ruff radon; do if ! python -m $t --version >/dev/null 2>&1; then echo \"‚ö†Ô∏è Python tool $t no encontrada en venv. Inst√°la con: pip install $t\"; missing=1; fi; done; fi; if [ $missing -eq 0 ]; then echo '‚úÖ Todas las herramientas QA est√°n disponibles'; else echo '‚ùå TIMEOUT POSIBLE: Faltan herramientas QA. Instala las herramientas faltantes para evitar timeouts.'; fi"
          }
        ]
      },
      {
        "matcher": "Edit|Write|MultiEdit",
        "hooks": [
          {
            "type": "command",
            "timeout": 5,
            "command": "echo 'Escaneando secretos (timeout: 5s)...'; git secrets --scan 2>/dev/null || echo 'No secrets found'"
          }
        ]
      },
      {
        "matcher": "Edit|Write|MultiEdit",
        "hooks": [
          {
            "type": "command",
            "timeout": 10,
            "command": "echo 'Quality Gate: Pre-commit security scan (timeout: 10s)...'; if command -v semgrep >/dev/null 2>&1; then files=$(find . -name '*.ts' -o -name '*.tsx' -o -name '*.js' -o -name '*.jsx' | head -10); if [ -n \"$files\" ]; then echo \"$files\" | xargs semgrep --config=auto --severity=ERROR --quiet 2>/dev/null || echo '‚úÖ Security scan passed'; else echo 'No JavaScript/TypeScript files to scan'; fi; else echo '‚ö†Ô∏è Semgrep not available - install with: pip install semgrep'; fi"
          }
        ]
      },
      {
        "matcher": "Edit|Write|MultiEdit",
        "hooks": [
          {
            "type": "command",
            "timeout": 8,
            "command": "echo 'Quality Gate: ESLint check with granular config (timeout: 8s)...'; if [ -f yarn.lock ]; then ESLINT_CMD='./node_modules/.bin/eslint'; elif command -v npx >/dev/null 2>&1; then ESLINT_CMD='npx eslint'; else echo '‚ö†Ô∏è ESLint not available'; exit 0; fi; changed_files=$(git status --porcelain 2>/dev/null | grep -E '\\.(ts|tsx|js|jsx)$' | awk '{print $2}' | head -5); if [ -n \"$changed_files\" ]; then echo \"Checking files: $changed_files\"; echo \"$changed_files\" | xargs $ESLINT_CMD --max-warnings=0 2>/dev/null && echo '‚úÖ ESLint check passed with granular config' || echo '‚ùå ESLint issues detected'; else echo 'No JavaScript/TypeScript files changed'; fi"
          }
        ]
      },
      {
        "matcher": "Edit|Write|MultiEdit",
        "hooks": [
          {
            "type": "command",
            "timeout": 3,
            "command": "echo 'Verificando migraciones (timeout: 3s)...'; manage.py makemigrations --check 2>/dev/null && echo 'No pending migrations' || echo '‚ö†Ô∏è Pending migrations detected'"
          }
        ]
      },
      {
        "matcher": "Edit|Write|MultiEdit",
        "hooks": [
          {
            "type": "command",
            "timeout": 2,
            "command": "echo 'Validando API spec (timeout: 2s)...'; spectral lint api-spec.yaml || true"
          }
        ]
      }
    ],
    "PostToolUse": [
      {
        "matcher": "Edit|Write|MultiEdit",
        "hooks": [
          {
            "type": "command",
            "timeout": 30,
            "command": "echo 'Aplicando auto-formato (timeout: 30s)...'; files_from_json=\"\"; if [ ! -t 0 ]; then files_from_json=$(python - <<'PY' 2>/dev/null || echo \"\"\nimport sys,json\ntry:\n  j=json.load(sys.stdin)\n  paths=set()\n  ti=j.get('tool_input') or {}\n  tr=j.get('tool_response') or {}\n  for k in ('file_path','path','filePath'):\n    if isinstance(ti,dict) and ti.get(k): paths.add(ti[k])\n    if isinstance(tr,dict) and tr.get(k): paths.add(tr[k])\n  for k in ('files','changes','editedFiles'):\n    v=tr.get(k)\n    if isinstance(v,list):\n      for x in v:\n        if isinstance(x,str): paths.add(x)\n        elif isinstance(x,dict):\n          for kk in ('file','path','filePath'):\n            if kk in x: paths.add(x[kk])\n  print('\\n'.join(sorted(paths)))\nexcept:\n  pass\nPY\n); fi; if [ -z \"$files_from_json\" ]; then echo \"Falling back to git detection...\"; changed_git=$(git status --porcelain -z 2>/dev/null | tr '\\0' '\\n' | awk '{print $2}'); changed_sess=$( [ -f .cc-session-start ] && find . -type f -newer .cc-session-start 2>/dev/null | sed 's|^\\./||' ); files=$(printf \"%s\\n%s\\n\" \"$changed_git\" \"$changed_sess\" | sort -u); else files=\"$files_from_json\"; echo \"Using files from JSON input: $files\"; fi; files=$(printf \"%s\\n\" \"$files\" | grep -Ev '(^|/)(coverage|node_modules|\\.venv|build|dist|\\.git|\\.cache|\\.pytest_cache)(/|$)' | grep -Ev '\\.(min\\.js|min\\.css)$' || true); if [ -z \"$files\" ]; then echo \"No files to format\"; exit 0; fi; echo \"Files to format: $files\"; for f in $files; do if [ ! -f \"$f\" ]; then echo \"Skipping non-existent file: $f\"; continue; fi; echo \"Formatting: $f\"; case \"$f\" in *.py) OS_TYPE=''; if [ -n \"$WSL_DISTRO_NAME\" ] || [ -f /proc/version ] && grep -q Microsoft /proc/version 2>/dev/null; then OS_TYPE='wsl'; elif [[ \"$OSTYPE\" == \"msys\" ]] || [[ \"$OSTYPE\" == \"cygwin\" ]] || [ \"$(uname -o 2>/dev/null)\" = \"Msys\" ]; then OS_TYPE='windows'; else OS_TYPE='linux'; fi; case \"$OS_TYPE\" in 'windows') [ -f backend/.venv/Scripts/activate ] && . backend/.venv/Scripts/activate ;; 'wsl'|'linux') [ -f backend/.venv/bin/activate ] && . backend/.venv/bin/activate ;; esac; case \"$f\" in backend/*) ruff \"$f\" --fix || true; black \"$f\" --quiet --line-length=100 2>/dev/null || true ;; *) echo \"Skipping Python file outside backend: $f\" ;; esac ;; *.ts|*.tsx|*.js|*.jsx|*.cjs|*.mjs) if [ -f yarn.lock ]; then ./node_modules/.bin/eslint \"$f\" --max-warnings=0 --fix || true; ./node_modules/.bin/prettier --write \"$f\" || true; else npx eslint \"$f\" --max-warnings=0 --fix || true; npx prettier --write \"$f\" || true; fi ;; *.css|*.scss|*.sass|*.less) if [ -f yarn.lock ]; then ./node_modules/.bin/prettier --write \"$f\" || true; else npx prettier --write \"$f\" || true; fi ;; *.html|*.htm) if [ -f yarn.lock ]; then ./node_modules/.bin/prettier --write \"$f\" || true; else npx prettier --write \"$f\" || true; fi ;; *.json|*.jsonc) if [ -f yarn.lock ]; then ./node_modules/.bin/prettier --write \"$f\" || true; else npx prettier --write \"$f\" || true; fi ;; *.md|*.mdx) markdownlint-cli2 --fix \"$f\" || true; if [ -f yarn.lock ]; then ./node_modules/.bin/prettier --write \"$f\" || true; else npx prettier --write \"$f\" || true; fi ;; *.yml|*.yaml) if command -v yamlfix >/dev/null 2>&1; then yamlfix \"$f\" || true; else yamllint \"$f\" || true; fi; if [ -f yarn.lock ]; then ./node_modules/.bin/prettier --write \"$f\" || true; else npx prettier --write \"$f\" || true; fi ;; *.xml|*.svg) if [ -f yarn.lock ]; then ./node_modules/.bin/prettier --write \"$f\" --parser xml || true; else npx prettier --write \"$f\" --parser xml || true; fi ;; *.toml) command -v taplo >/dev/null 2>&1 && taplo format \"$f\" || true ;; *.sh|*.bash|*.zsh) scdiff=$(shellcheck -f diff \"$f\" 2>/dev/null || true); [ -n \"$scdiff\" ] && printf \"%s\" \"$scdiff\" | patch -p0 --silent || true; (command -v shfmt >/dev/null 2>&1 && shfmt -w -i 2 -ci -sr \"$f\") || ([ -x './bin/shfmt.exe' ] && ./bin/shfmt.exe -w -i 2 -ci -sr \"$f\") || true ;; esac; done; echo \"Auto-formatting complete\""
          }
        ]
      },
      {
        "matcher": "Edit|Write|MultiEdit",
        "hooks": [
          {
            "type": "command",
            "timeout": 15,
            "command": "echo 'Analizando metricas de calidad (timeout: 15s)...'; fail=0; out='['; sep=''; files=$(python - <<'PY'\nimport sys,json\nj=json.load(sys.stdin)\npaths=set()\nti=j.get('tool_input') or {}\ntr=j.get('tool_response') or {}\nfor k in ('file_path','path','filePath'):\n    if isinstance(ti,dict) and ti.get(k): paths.add(ti[k])\n    if isinstance(tr,dict) and tr.get(k): paths.add(tr[k])\nfor k in ('files','changes','editedFiles'):\n    v=tr.get(k)\n    if isinstance(v,list):\n        for x in v:\n            if isinstance(x,str): paths.add(x)\n            elif isinstance(x,dict):\n                for kk in ('file','path','filePath'):\n                    if kk in x: paths.add(x[kk])\nprint('\\n'.join(sorted(paths)))\nPY\n); \nif [ -z \"$files\" ]; then \n  changed_git=$(git status --porcelain -z 2>/dev/null | tr '\\0' '\\n' | awk '{print $2}'); \n  changed_sess=$( [ -f .cc-session-start ] && find . -type f -newer .cc-session-start 2>/dev/null | sed 's|^\\./||' ); \n  files=$(printf \"%s\\n%s\\n\" \"$changed_git\" \"$changed_sess\" | sort -u)\nfi;\n# Excluir rutas irrelevantes (generados, dependencias, caches)\nfiles=$(printf \"%s\\n\" \"$files\" | grep -Ev '(^|/)(coverage|node_modules|\\.venv|build|dist|\\.git|\\.cache|\\.pytest_cache)(/|$)' | grep -Ev '\\.(min\\.js|min\\.css)$' || true)\n[ -z \"$files\" ] && { echo '‚Äî Design Metrics ‚Äî (sin archivos relevantes)'; exit 0; }\nfor f in $files; do \n  case \"$f\" in \n    *.py)\n      OS_TYPE=''; if [ -n \"$WSL_DISTRO_NAME\" ] || [ -f /proc/version ] && grep -q Microsoft /proc/version 2>/dev/null; then OS_TYPE='wsl'; elif [[ \"$OSTYPE\" == \"msys\" ]] || [[ \"$OSTYPE\" == \"cygwin\" ]] || [ \"$(uname -o 2>/dev/null)\" = \"Msys\" ]; then OS_TYPE='windows'; else OS_TYPE='linux'; fi; case \"$OS_TYPE\" in 'windows') [ -f backend/.venv/Scripts/activate ] && . backend/.venv/Scripts/activate ;; 'wsl'|'linux') [ -f backend/.venv/bin/activate ] && . backend/.venv/bin/activate ;; esac; \n      loc=$(wc -l < \"$f\" 2>/dev/null || echo 0); \n      if command -v radon >/dev/null 2>&1; then \n        maxcc=$(radon cc -s -j \"$f\" 2>/dev/null | python - <<'PY'\nimport json,sys\ntry:\n  j=json.load(sys.stdin)\nexcept Exception:\n  print(0); sys.exit(0)\nmx=0\nfor _,items in j.items():\n  for it in items:\n    try:\n      mx=max(mx,int(it.get('complexity',0)))\n    except Exception:\n      pass\nprint(mx)\nPY\n); \n      else echo \"[PY] $f | ‚ö†Ô∏è radon no disponible (pip install radon)\"; maxcc=0; fi; \n      [ \"$maxcc\" -le 10 ] || cc_band='yellow'; [ \"$maxcc\" -le 15 ] || { cc_band='red'; }; [ -n \"$cc_band\" ] || cc_band='green'; \n      [ \"$loc\" -le 212 ] || loc_band='yellow'; [ \"$loc\" -le 300 ] || { loc_band='red'; }; [ -n \"$loc_band\" ] || loc_band='green'; \n      [ \"$cc_band\" = 'red' ] && fail=1; [ \"$loc_band\" = 'red' ] && fail=1; \n      out=\"$out$sep{\\\"lang\\\":\\\"py\\\",\\\"file\\\":\\\"$f\\\",\\\"cc\\\":$maxcc,\\\"ccBand\\\":\\\"$cc_band\\\",\\\"loc\\\":$loc,\\\"locBand\\\":\\\"$loc_band\\\"}\"; sep=\",\" \n      ;;\n    *.ts|*.tsx|*.js|*.jsx|*.cjs|*.mjs)\n      loc=$(wc -l < \"$f\" 2>/dev/null || echo 0); \n      if [ -f yarn.lock ]; then ycmd='./node_modules/.bin'; else ycmd='npx'; fi; \n      $ycmd/eslint \"$f\" --no-error-on-unmatched-pattern --rule '{\"complexity\":[\"error\",10]}' >/dev/null 2>&1; ec10=$?; \n      $ycmd/eslint \"$f\" --no-error-on-unmatched-pattern --rule '{\"complexity\":[\"error\",15]}' >/dev/null 2>&1; ec15=$?; \n      if [ $ec10 -eq 0 ]; then cc_band='green'; elif [ $ec15 -eq 0 ]; then cc_band='yellow'; else cc_band='red'; fi; \n      [ \"$loc\" -le 212 ] || loc_band='yellow'; [ \"$loc\" -le 300 ] || { loc_band='red'; }; [ -n \"$loc_band\" ] || loc_band='green'; \n      [ \"$cc_band\" = 'red' ] && fail=1; [ \"$loc_band\" = 'red' ] && fail=1; \n      out=\"$out$sep{\\\"lang\\\":\\\"js\\\",\\\"file\\\":\\\"$f\\\",\\\"ccBand\\\":\\\"$cc_band\\\",\\\"loc\\\":$loc,\\\"locBand\\\":\\\"$loc_band\\\"}\"; sep=\",\" \n      ;;\n  esac; done; \n  out=\"$out]\"; echo \"$out\" > .cc-metrics-fail.json; \n  if [ $fail -ne 0 ]; then \n    echo '‚ùå Design Metrics en ROJO (CC>15 o LOC>300). Si timeout, revisa .cc-metrics-fail.json para detalles.' 1>&2; \n    exit 2; \n  else rm -f .cc-metrics-fail.json >/dev/null 2>&1 || true; fi"
          }
        ]
      }
    ],
    "postSubAgent": [
      {
        "matcher": "task-dev",
        "hooks": [
          {
            "type": "command",
            "timeout": 6,
            "command": "echo 'Post-SubAgent: Task DoD Validation (timeout: 6s)...'; echo '‚úÖ DoD validation completed (direct validation)'"
          }
        ]
      },
      {
        "matcher": "pr-flow",
        "hooks": [
          {
            "type": "command",
            "timeout": 5,
            "command": "echo 'Post-SubAgent: PR Convention Validation (timeout: 5s)...'; if git status --porcelain 2>/dev/null | grep -q '^[AMDR]'; then last_commit=$(git log -1 --pretty=format:'%s' 2>/dev/null); if echo \"$last_commit\" | grep -qE '^(feat|fix|docs|style|refactor|test|chore)(\\(.+\\))?: .+'; then echo \"‚úÖ Conventional commit: $last_commit\"; else echo \"‚ö†Ô∏è Non-conventional commit: $last_commit\"; fi; echo 'Changes staged for PR'; else echo 'No staged changes for PR'; fi"
          }
        ]
      },
      {
        "matcher": "release-prep",
        "hooks": [
          {
            "type": "command",
            "timeout": 4,
            "command": "echo 'Post-SubAgent: Release Validation (timeout: 4s)...'; if [ -n \"$RELEASE_ID\" ]; then echo \"üöÄ Release $RELEASE_ID preparation status: validated\"; else echo 'No release context'; fi"
          }
        ]
      },
      {
        "matcher": "commit-smart|adr-create|issue-generate|docs-update",
        "hooks": [
          {
            "type": "command",
            "timeout": 3,
            "command": "echo 'Post-SubAgent: Governance Validation (timeout: 3s)...'; case \"$0\" in *commit-smart*) echo '‚úÖ Smart commit with quality gates completed'; if [ -n \"$TASK_ID\" ]; then echo \"üìã Task $TASK_ID status updated\"; fi;; *adr-create*) echo 'üìã ADR created with proper numbering and indexing';; *issue-generate*) echo 'üé´ GitHub issue generated with context';; *docs-update*) echo 'üìä Documentation and traceability updated';; esac"
          }
        ]
      },
      {
        "matcher": ".*",
        "hooks": [
          {
            "type": "command",
            "timeout": 2,
            "command": "echo 'Post-SubAgent: Workflow Summary (timeout: 2s)...'; echo \"Workflow: ${WORKFLOW_TYPE:-unknown} | Sub-agent: ${SUB_AGENT:-none} | Context: ${TASK_ID:-${RELEASE_ID:-general}}\"; if [ -f .cc-session-start ]; then session_duration=$(($(date +%s) - $(stat -c %Y .cc-session-start 2>/dev/null || date +%s))); echo \"Session: ${session_duration}s\"; fi"
          }
        ]
      }
    ]
  }
}
